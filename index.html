import React, { useState, useMemo } from 'react';
import { 
  Moon, 
  Utensils, 
  Activity, 
  Brain, 
  RotateCcw,
  Info,
  User,
  Heart,
  Battery,
  Smile,
  Shield,
  Dna
} from 'lucide-react';

// --- Simulation Logic ---

const calculateMetrics = (sleep, diet, exercise, stress, age) => {
  // 1. Sleep Score (Bell curve around 8h)
  let sScore = 100 - Math.abs(8 - sleep) * 15;
  if (sleep < 4) sScore = 20;
  sScore = Math.max(0, Math.min(100, sScore));

  // 2. Diet Score (Harvard Plate Balance)
  const totalDiet = diet.veg + diet.prot + diet.grain + diet.junk;
  let dScore = 0;
  if (totalDiet > 0) {
    const pVeg = (diet.veg / totalDiet) * 100;
    const pProt = (diet.prot / totalDiet) * 100;
    const pJunk = (diet.junk / totalDiet) * 100;
    
    // Ideal: 50% Veg, 25% Prot. Penalty for junk.
    const quality = 100 - (Math.abs(50 - pVeg) + Math.abs(25 - pProt));
    dScore = Math.max(0, quality - (pJunk * 2));
  }

  // 3. Exercise Score
  // Intensity needs to be moderate-high, but not extreme without sleep
  let eScore = exercise.intensity;
  if (exercise.intensity > 80 && sScore < 50) eScore -= 40; // Overtraining penalty
  eScore = Math.max(0, Math.min(100, eScore));

  // 4. Stress Score (Net Stress)
  const netStress = Math.max(0, stress.load - stress.mgmt);
  const strScore = Math.max(0, 100 - netStress);

  // --- Derived Biometrics ---
  
  // Age Factor: As you get older, it's harder to maintain high vitality
  const agePenalty = Math.max(0, (age - 30) * 0.5); 

  // Energy: Driven by Sleep & Diet
  let energy = (sScore * 0.5 + dScore * 0.3 + eScore * 0.2) - (agePenalty * 0.5);
  
  // Mood: Driven by Stress & Exercise
  let mood = (strScore * 0.4 + sScore * 0.3 + eScore * 0.3);
  
  // Immunity: Driven by Diet & Sleep
  let immunity = (dScore * 0.5 + sScore * 0.4 + eScore * 0.1) - (agePenalty * 0.8);

  // Biological Age (Visual aging): Chronological age + penalty for bad habits
  const vitalityAvg = (energy + mood + immunity) / 3;
  const biologicalAge = age + ((100 - vitalityAvg) / 5);

  return {
    energy: Math.max(10, Math.min(100, energy)),
    mood: Math.max(10, Math.min(100, mood)),
    immunity: Math.max(10, Math.min(100, immunity)),
    vitality: Math.max(0, Math.min(100, vitalityAvg)),
    biologicalAge,
    sScore, dScore, eScore, strScore
  };
};

// --- Visual Components ---

const Humanoid = ({ gender, age, metrics, diet, exercise }) => {
  // Visual Parameters derived from state
  
  // 1. Posture (0 = slumped, 1 = upright)
  const posture = metrics.energy / 100; 
  const headY = 40 + (1 - posture) * 15; // Head drops when tired
  const shoulderY = 75 + (1 - posture) * 10;
  
  // 2. Body Composition
  // "Width" driven by Junk Food vs Exercise
  const caloricExcess = (diet.junk * 2 + diet.grain) - (exercise.intensity / 5);
  const bodyWidth = 40 + Math.max(0, caloricExcess * 2); // Base width 40
  
  // 3. Muscle Definition (Stroke width)
  const muscle = 2 + (exercise.intensity / 20);

  // 4. Aging (Hair & Wrinkles)
  const isOld = metrics.biologicalAge > 60;
  const isVeryOld = metrics.biologicalAge > 80;
  const hairColor = metrics.biologicalAge > 65 ? "#e2e8f0" : metrics.biologicalAge > 45 ? "#94a3b8" : "#3f2c22";
  
  // Gender shapes
  const isFemale = gender === 'female';
  const hipWidth = isFemale ? bodyWidth + 15 : bodyWidth;
  const shoulderWidth = isFemale ? bodyWidth : bodyWidth + 15;

  // Colors based on health
  const skinTone = metrics.immunity < 40 ? "#e2e8d0" : "#f5d0b0"; // Pale if sick
  const shirtColor = isFemale ? "#f472b6" : "#60a5fa";

  return (
    <svg viewBox="0 0 200 400" className="w-full h-full drop-shadow-2xl transition-all duration-700">
      <defs>
        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
          <feGaussianBlur stdDeviation="5" result="blur" />
          <feComposite in="SourceGraphic" in2="blur" operator="over" />
        </filter>
      </defs>

      {/* Aura / Vitality Glow */}
      <ellipse 
        cx="100" cy="200" 
        rx={60 + metrics.vitality/2} ry={150} 
        fill={metrics.vitality > 80 ? "rgba(74, 222, 128, 0.2)" : "rgba(0,0,0,0)"} 
        filter="url(#glow)"
        className="transition-all duration-1000"
      />

      {/* LEGS */}
      <g stroke={skinTone} strokeWidth={muscle + 10} strokeLinecap="round">
        <line x1="85" y1="220" x2="85" y2="380" />
        <line x1="115" y1="220" x2="115" y2="380" />
      </g>
      {/* Clothing (Pants) */}
      <g stroke="#334155" strokeWidth={muscle + 12} strokeLinecap="round">
         <line x1="85" y1="220" x2="85" y2="300" />
         <line x1="115" y1="220" x2="115" y2="300" />
      </g>

      {/* TORSO */}
      {/* Dynamic shape based on gender and weight */}
      <path 
        d={`
          M ${100 - shoulderWidth/2} ${shoulderY} 
          Q ${100 - bodyWidth/2} 150 ${100 - hipWidth/2} 220 
          L ${100 + hipWidth/2} 220 
          Q ${100 + bodyWidth/2} 150 ${100 + shoulderWidth/2} ${shoulderY} 
          Z
        `} 
        fill={shirtColor}
        className="transition-all duration-700"
      />

      {/* ARMS */}
      <g stroke={skinTone} strokeWidth={muscle + 8} strokeLinecap="round">
        {/* Left Arm - droops if posture is bad */}
        <path d={`M ${100 - shoulderWidth/2} ${shoulderY + 5} Q ${60 - (1-posture)*10} 150 ${65} ${200 + (1-posture)*30}`} fill="none" />
        {/* Right Arm */}
        <path d={`M ${100 + shoulderWidth/2} ${shoulderY + 5} Q ${140 + (1-posture)*10} 150 ${135} ${200 + (1-posture)*30}`} fill="none" />
      </g>

      {/* HEAD Group (Moves with posture) */}
      <g transform={`translate(0, ${headY - 40})`} className="transition-all duration-700">
        
        {/* Neck */}
        <rect x="90" y="30" width="20" height="30" fill={skinTone} />

        {/* Face Shape */}
        <ellipse cx="100" cy="30" rx="28" ry="34" fill={skinTone} />

        {/* Hair */}
        {isFemale ? (
           // Long Hair
           <path d="M 70 10 Q 100 -10 130 10 L 135 60 Q 100 70 65 60 Z" fill={hairColor} />
        ) : (
           // Short Hair
           <path d="M 72 15 Q 100 -5 128 15 L 128 30 Q 100 20 72 30 Z" fill={hairColor} />
        )}

        {/* Eyes */}
        <g fill="#1e293b">
          <circle cx="90" cy="25" r={metrics.energy < 30 ? 1.5 : 2.5} />
          <circle cx="110" cy="25" r={metrics.energy < 30 ? 1.5 : 2.5} />
          {/* Bags under eyes if tired */}
          {metrics.sScore < 40 && (
            <g stroke="#000" strokeOpacity="0.1" strokeWidth="2" fill="none">
              <path d="M 86 30 Q 90 33 94 30" />
              <path d="M 106 30 Q 110 33 114 30" />
            </g>
          )}
        </g>

        {/* Mouth - Mood Dependent */}
        <path 
          d={metrics.mood > 60 
            ? "M 88 45 Q 100 55 112 45" // Smile
            : metrics.mood < 40 
              ? "M 88 50 Q 100 40 112 50" // Frown
              : "M 90 48 L 110 48" // Neutral
          }
          stroke="#1e293b" 
          strokeWidth="2" 
          fill="none" 
          strokeLinecap="round"
        />

        {/* Wrinkles (Age Dependent) */}
        {isOld && (
          <g stroke="#000" strokeOpacity="0.15" strokeWidth="1" fill="none">
             <path d="M 85 15 Q 100 20 115 15" /> 
             <path d="M 88 10 Q 100 15 112 10" />
             {isVeryOld && <path d="M 100 45 L 100 55" />} {/* Mouth lines */}
          </g>
        )}
      </g>
    </svg>
  );
};

const ControlPanel = ({ title, icon: Icon, color, children }) => (
  <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4">
    <div className={`px-4 py-3 bg-${color}-50 border-b border-${color}-100 flex items-center gap-2`}>
      <Icon className={`text-${color}-600`} size={18} />
      <span className={`font-bold text-${color}-900 text-sm uppercase tracking-wide`}>{title}</span>
    </div>
    <div className="p-4 space-y-4">
      {children}
    </div>
  </div>
);

const Slider = ({ label, value, min, max, onChange, unit }) => (
  <div className="space-y-1">
    <div className="flex justify-between text-xs font-semibold text-slate-600">
      <label>{label}</label>
      <span>{value} {unit}</span>
    </div>
    <input 
      type="range" 
      min={min} 
      max={max} 
      value={value} 
      onChange={(e) => onChange(Number(e.target.value))}
      className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
    />
  </div>
);

// --- Main Application ---

export default function VitalityLab() {
  const [gender, setGender] = useState('female');
  const [age, setAge] = useState(25);
  
  const [sleep, setSleep] = useState(7.5);
  const [diet, setDiet] = useState({ veg: 5, prot: 5, grain: 5, junk: 2 });
  const [exercise, setExercise] = useState({ intensity: 50 });
  const [stress, setStress] = useState({ load: 40, mgmt: 30 });

  const metrics = useMemo(() => calculateMetrics(sleep, diet, exercise, stress, age), [sleep, diet, exercise, stress, age]);

  const reset = () => {
    setAge(25);
    setSleep(7.5);
    setDiet({ veg: 5, prot: 5, grain: 5, junk: 2 });
    setExercise({ intensity: 50 });
    setStress({ load: 40, mgmt: 30 });
  };

  return (
    <div className="min-h-screen bg-slate-100 p-4 font-sans text-slate-800">
      
      {/* Top Bar */}
      <div className="max-w-7xl mx-auto flex items-center justify-between mb-6 bg-white p-4 rounded-xl shadow-sm">
        <div className="flex items-center gap-3">
          <div className="bg-blue-600 p-2 rounded-lg text-white">
            <Dna size={24} />
          </div>
          <div>
            <h1 className="text-2xl font-black text-slate-800 tracking-tight">VITALITY LAB</h1>
            <p className="text-xs text-slate-500 font-medium uppercase tracking-widest">Interactive Health Simulation</p>
          </div>
        </div>
        <button onClick={reset} className="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-full font-bold text-slate-600 text-sm transition-colors">
          <RotateCcw size={16} /> Reset
        </button>
      </div>

      <div className="max-w-7xl mx-auto grid grid-cols-12 gap-6 h-[calc(100vh-140px)]">
        
        {/* LEFT: Controls */}
        <div className="col-span-12 md:col-span-3 overflow-y-auto pr-2 custom-scrollbar space-y-4">
          
          {/* Identity Control */}
          <ControlPanel title="Subject Identity" icon={User} color="blue">
            <div className="flex bg-slate-100 p-1 rounded-lg">
              {['male', 'female'].map(g => (
                <button 
                  key={g}
                  onClick={() => setGender(g)}
                  className={`flex-1 py-1.5 text-xs font-bold rounded-md capitalize transition-all ${gender === g ? 'bg-white shadow text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}
                >
                  {g}
                </button>
              ))}
            </div>
            <Slider label="Chronological Age" value={age} min={18} max={90} onChange={setAge} unit="yrs" />
          </ControlPanel>

          {/* Sleep */}
          <ControlPanel title="Sleep Hygiene" icon={Moon} color="indigo">
            <Slider label="Nightly Duration" value={sleep} min={0} max={12} onChange={setSleep} unit="hrs" />
          </ControlPanel>

          {/* Diet */}
          <ControlPanel title="Dietary Composition" icon={Utensils} color="green">
            <Slider label="Vegetables & Fruits" value={diet.veg} min={0} max={10} onChange={v => setDiet({...diet, veg: v})} unit="" />
            <Slider label="Lean Protein" value={diet.prot} min={0} max={10} onChange={v => setDiet({...diet, prot: v})} unit="" />
            <Slider label="Processed/Sugar" value={diet.junk} min={0} max={10} onChange={v => setDiet({...diet, junk: v})} unit="" />
          </ControlPanel>

          {/* Exercise */}
          <ControlPanel title="Activity Level" icon={Activity} color="orange">
            <Slider label="Weekly Intensity" value={exercise.intensity} min={0} max={100} onChange={v => setExercise({...exercise, intensity: v})} unit="%" />
          </ControlPanel>

          {/* Stress */}
          <ControlPanel title="Stress Factors" icon={Brain} color="purple">
            <Slider label="External Load" value={stress.load} min={0} max={100} onChange={v => setStress({...stress, load: v})} unit="%" />
            <Slider label="Active Management" value={stress.mgmt} min={0} max={100} onChange={v => setStress({...stress, mgmt: v})} unit="%" />
          </ControlPanel>
        </div>

        {/* CENTER: The Stage (PhET Style) */}
        <div className="col-span-12 md:col-span-6 flex flex-col">
          <div className="flex-1 bg-white rounded-2xl shadow-lg border border-slate-200 relative overflow-hidden flex items-center justify-center p-8">
            
            {/* Background Decor (Grid/Floor) */}
            <div className="absolute inset-0 opacity-5 pointer-events-none">
              <div className="h-3/4 w-full bg-slate-200" style={{backgroundSize: '40px 40px', backgroundImage: 'linear-gradient(to right, #94a3b8 1px, transparent 1px), linear-gradient(to bottom, #94a3b8 1px, transparent 1px)'}}></div>
              <div className="h-1/4 w-full bg-slate-300"></div>
            </div>

            {/* The Avatar */}
            <div className="relative z-10 w-full max-w-sm h-full">
              <Humanoid gender={gender} age={age} metrics={metrics} diet={diet} exercise={exercise} />
            </div>

            {/* Live Stats Overlay */}
            <div className="absolute top-4 right-4 bg-white/90 backdrop-blur p-4 rounded-xl border border-slate-200 shadow-sm text-right">
              <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Biological Age</h3>
              <div className={`text-3xl font-black ${metrics.biologicalAge > age ? 'text-red-500' : 'text-green-500'}`}>
                {Math.round(metrics.biologicalAge)} <span className="text-sm text-slate-400 font-medium">yrs</span>
              </div>
            </div>

          </div>
        </div>

        {/* RIGHT: Data Output */}
        <div className="col-span-12 md:col-span-3 space-y-4">
          <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
            <div className="flex items-center gap-2 mb-6 text-slate-700">
              <Info size={20} />
              <h2 className="font-bold uppercase text-sm tracking-wide">Real-time Analysis</h2>
            </div>
            
            <div className="space-y-6 flex-1">
              {/* Metric Bars */}
              {[
                { label: "Energy & Vitality", val: metrics.energy, icon: Battery, color: "yellow" },
                { label: "Mood Balance", val: metrics.mood, icon: Smile, color: "purple" },
                { label: "Immune Response", val: metrics.immunity, icon: Shield, color: "green" },
                { label: "Heart Health", val: (metrics.eScore + metrics.dScore)/2, icon: Heart, color: "rose" }
              ].map((m, i) => (
                <div key={i}>
                  <div className="flex justify-between items-center mb-1 text-sm font-semibold text-slate-600">
                    <div className="flex items-center gap-2">
                      <m.icon size={14} /> {m.label}
                    </div>
                    <span>{Math.round(m.val)}</span>
                  </div>
                  <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div 
                      className={`h-full bg-${m.color}-500 transition-all duration-700`}
                      style={{ width: `${m.val}%` }}
                    />
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-8 pt-6 border-t border-slate-100 bg-slate-50 -mx-5 -mb-5 p-5 rounded-b-xl">
              <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Observations</h4>
              <p className="text-sm text-slate-600 leading-relaxed">
                {metrics.biologicalAge > age + 5 && "‚ö†Ô∏è Your lifestyle is causing premature aging."}
                {metrics.biologicalAge < age - 2 && "üåü Excellent! You are biologically younger than your calendar age."}
                {Math.abs(metrics.biologicalAge - age) <= 2 && "‚úÖ Your health is consistent with your age."}
              </p>
            </div>
          </div>
        </div>

      </div>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      `}</style>
    </div>
  );
}
